$(function(){initPages();bindEvent()});function initPages(){initDateSelect();initBusinessTable()}function initBusinessTable(){initBusinessFilter();var B=$(window).height()-160;var A=false;if($(window).width()<=768){A=true}$("#businessData").bootstrapTable({cardView:A,undefinedText:"",cache:false,height:B,striped:true,pagination:true,pageSize:50,pageList:[10,25,50,100,200],sidePagination:"server",onPageChange:function(D,C){var E=$("#businessData").bootstrapTable("getOptions");var F=E.sortName;var G=E.sortOrder;getData(D,C,F,G)},onSort:function(E,F){var D=$("#businessData").bootstrapTable("getOptions");var G=D.pageNumber;var C=D.pageSize;getData(G,C,E,F)}});initprivilege($("#businessData"));getData(1,50)}function initVisitTable(){initVisitFilter();var B=$(window).height()-120;var A=false;if($(window).width()<=768){A=true}$("#visitData").bootstrapTable({cardView:A,undefinedText:"",cache:false,height:B,striped:true,pagination:true,pageSize:50,pageList:[10,25,50,100,200],sidePagination:"server",onPageChange:function(D,C){var E=$("#visitData").bootstrapTable("getOptions");var F=E.sortName;var G=E.sortOrder;getVisitData(D,C,F,G)},onSort:function(E,F){var D=$("#visitData").bootstrapTable("getOptions");var G=D.pageNumber;var C=D.pageSize;getVisitData(G,C,E,F)}});initprivilege($("#visitData"));getVisitData(1,50)}function getData(J,G,A,H){var D=dateRange.getCurrentDate().startDate;var C=dateRange.getCurrentDate().endDate;var E=$("#businesserfilter").val();if(E==-1){E=""}var B=$("#cityfilter").val();if(B==-1){B=""}var F=$("#cluefilter").val();if(F==-1){F=""}var K=$("#datafilter").val();if(K==-1){K=""}var I={"beginDate":D,"endDate":C,"businesser":E,"city":B,"clue":F,"dataStatus":K,"pageNumber":J,"pageSize":G,"sortName":A,"order":H};$("#businessData").bootstrapTable("showLoading");$.ajax({url:"getAllBusiness.do",data:{"paramModel":JSON.stringify(I)},method:"post",async:true,success:function(M){if(M.statusCode==504){$.messager.popup("系统错误，错误代码504。")}else{var L={total:M.content.totalRecord,rows:M.content.business};$("#businessData").bootstrapTable("hideLoading");$("#businessData").bootstrapTable("load",L);addActiveClass()}}})}function getVisitData(A,F,I,G){var H=dateRange.getCurrentDate().startDate;var B=dateRange.getCurrentDate().endDate;var E=$("#businesserfilter1").val();if(E==-1){E=""}var C=$("#customerStatusfilter").val();if(C==-1){C=""}var D={"startDate":H,"endDate":B,"businesser":E,"customerStatus":C,"pageNumber":A,"pageSize":F,"sortName":I,"order":G};$("#visitData").bootstrapTable("showLoading");$.ajax({url:"getBusinessVisitDatas.do",data:{"queryParam":JSON.stringify(D)},method:"post",async:true,success:function(K){if(K.statusCode==504){$.messager.popup("系统错误，错误代码504。")}else{var J={total:K.content.totalRecord,rows:K.content.visitData};$("#visitData").bootstrapTable("hideLoading");$("#visitData").bootstrapTable("load",J);addActiveClass()}}})}function bindEvent(){$("#confirm").click(function(){getData(1,50);$("#cpBusiness").toggle();hidefilter()});$("#confirmVisit").click(function(){getVisitData(1,50);$("#visitfilter").toggle();hidefilter()});$("#saveVisitInfo").click(function(){updateVisitInfo()});window.businessEvents={"click .edit":function(A,D,C,B){openEditBusiness(C)},"click .remove":function(A,D,C,B){}};window.visitEvents={"click .edit":function(A,D,C,B){openEditVisit(C)}};window.viewCustomerInfo={"click .customerName":function(A,D,C,B){window.location.href="customerInfo.jsp?menuID=2&customerID="+C.customerID}};$('a[data-toggle="tab"]').on("shown.bs.tab",function(A){toggleTab(A)});$("#visitcancel").click(function(){$("#visitfilter").toggle();hidefilter()});$("#businesscancel").click(function(){$("#cpBusiness").toggle();hidefilter()});$("#filterBtn").click(function(){filterBtn()})}function openEditBusiness(A){$.ajax({url:"getCreateBusinessSelect.do",method:"post",async:true,success:function(F){var D=F.content.city;var E=F.content.clueStatus;var B=F.content.dataStatus;var C=setOption(D,1);$("#citySelect").html(C.join(""));C=setOption(E,1);$("#clueSelect").html(C.join(""));C=setOption(B,1);$("#dataSelect").html(C.join(""));$("#citySelect").val(A.city);$("#clueSelect").val(A.clue);$("#dataSelect").val(A.dataStatus)}});$("#inputcustomerName").val(A.customerName);$("#communicateStatus").val(A.communicateStatus.replace(new RegExp("<br>","gm"),"\n"));$("#saveBusinessInfo").click(function(){updateBusinessInfo(A)});$("#editBusiness").modal()}function updateBusinessInfo(A){var B={"city":$("#citySelect").val(),"cityValue":$("#citySelect").find("option:selected").text(),"clue":$("#clueSelect").val(),"clueValue":$("#clueSelect").find("option:selected").text(),"dataStatus":$("#dataSelect").val(),"dataStatusValue":$("#dataSelect").find("option:selected").text(),"communicateStatus":$("#communicateStatus").val().replace(new RegExp("\n","gm"),"<br>"),"businessID":A.businessID};$.ajax({url:"saveBusinessData.do",data:{"business":JSON.stringify(B)},method:"post",async:true,success:function(C){$.messager.popup("修改成功");$("#editBusiness").modal("hide");refreshTable($("#businessData"))}})}function toggleTab(A){var B=$(A.target).text();if($(A.target)[0].title){B=$(A.target)[0].title}if(B=="回访详情"){$("#cpBusiness").hide();$("#visitfilter").show();$("#visitfilter").toggle();initVisitTable()}else{if(B=="跟进信息"){$("#cpBusiness").show();$("#visitfilter").hide();$("#cpBusiness").toggle();initBusinessTable()}}}function initBusinessFilter(){$.ajax({url:"getCreateBusinessSelect.do",method:"post",async:false,success:function(F){var C=F.content.city;var D=F.content.clueStatus;var A=F.content.dataStatus;var E=F.content.businesser;var B=setOption(C);$("#cityfilter").html(B.join(""));B=setOption(D);$("#cluefilter").html(B.join(""));B=setOption(A);$("#datafilter").html(B.join(""));B=setOption(E);$("#businesserfilter").html(B.join(""))}})}function initVisitFilter(){$.ajax({url:"getVisitSelect.do",method:"post",async:false,success:function(D){var C=D.content.businesser;var B=D.content.customerStatus;var A=setOption(C);$("#businesserfilter1").html(A.join(""));A=setOption(B);$("#customerStatusfilter").html(A.join(""))}})}function filterBtn(){for(var A=0;A<$("#cpTab > li").length;A++){if($($("#cpTab > li")[A]).hasClass("active")){var B=$($("#cpTab > li")[A]).text();if(B=="跟进信息"){$("#cpBusiness").toggle()}else{if(B=="回访详情"){$("#visitfilter").toggle()}}}}if($("#iconbtn").hasClass("up-icon")==true){showfilter()}else{hidefilter()}}function query(){for(var A=0;A<$("#cpTab > li").length;A++){if($($("#cpTab > li")[A]).hasClass("active")){var B=$($("#cpTab > li")[A]).text();if(B=="跟进信息"){getData(1,50)}else{if(B=="回访详情"){getVisitData(1,50)}}}}};