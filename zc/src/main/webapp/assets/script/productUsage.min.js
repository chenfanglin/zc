$(function(){initPages();bindEvent()});function initPages(){initDateSelect();initCountTable($("#loginCount"),"logincount.do",0)}function getCountData(I,G,J,F,A,H){var E=dateRange.getCurrentDate().startDate;var C=dateRange.getCurrentDate().endDate;var B=$("#dropdownBtn").text().replace(/(^\s*)|(\s*$)/g,"");var K=$("#searchCompany").val();var D={"startDate":E,"endDate":C,"platform":B,"pageNumber":J,"pageSize":F,"sortName":A,"order":H,"keyValue":K};G.bootstrapTable("showLoading");$.ajax({url:I,data:{"queryParam":JSON.stringify(D)},method:"post",async:true,success:function(M){if(M.statusCode==504){$.messager.popup("系统错误，错误代码504。")}else{var L={total:M.content.totalRecord,rows:M.content.dynamicObject};G.bootstrapTable("hideLoading");G.bootstrapTable("load",L);addActiveClass()}}})}function getLoginData(F,H,I,E,A,G){var D=dateRange.getCurrentDate().startDate;var B=dateRange.getCurrentDate().endDate;var J=$("#searchCompany").val();var C={"startDate":D,"endDate":B,"pageNumber":I,"pageSize":E,"sortName":A,"order":G,"keyValue":J};F.bootstrapTable("showLoading");$.ajax({url:H,data:{"queryParam":JSON.stringify(C)},method:"post",async:true,success:function(L){if(L.statusCode==504){$.messager.popup("系统错误，错误代码504。")}else{var K={total:L.content.totalRecord,rows:L.content.customer};F.bootstrapTable("hideLoading");F.bootstrapTable("load",K)}}})}function initCountTable(D,C,F){var B=[];var E=dateRange.getCurrentDate().startDate;var A=dateRange.getCurrentDate().endDate;$.ajax({url:"getColumns.do",data:{"startDate":E,"endDate":A,"flag":F},type:"post",async:true,success:function(I){B.push(I.content);var H=$(window).height()-160;var G=false;if($(window).width()<=768){G=true}D.bootstrapTable("destroy");D.bootstrapTable({cardView:G,undefinedText:"",cache:false,height:H,striped:true,pagination:true,pageSize:50,pageList:[10,25,50,100,200],sidePagination:"server",columns:B,onPageChange:function(K,J){var L=D.bootstrapTable("getOptions");var M=L.sortName;var N=L.sortOrder;getCountData(C,D,K,J,M,N)},onSort:function(L,M){var K=D.bootstrapTable("getOptions");var N=K.pageNumber;var J=K.pageSize;getCountData(C,D,N,J,L,M)},rowStyle:function(J,K){if(K%2==0){return{classes:"odd_row"}}else{return{classes:"even_row"}}}});getCountData(C,D,1,50)}})}function initLoginTable(C,B){var D=$(window).height()-160;var A=false;if($(window).width()<=768){A=true}C.bootstrapTable({cardView:A,undefinedText:"",cache:false,height:D,striped:true,pagination:true,pageSize:50,pageList:[10,25,50,100,200],sidePagination:"server",onPageChange:function(F,E){var G=C.bootstrapTable("getOptions");var H=G.sortName;var I=G.sortOrder;getLoginData(C,B,F,E,H,I)},onSort:function(G,H){var F=C.bootstrapTable("getOptions");var I=F.pageNumber;var E=F.pageSize;getLoginData(C,B,I,E,G,H)},rowStyle:function(E,F){if(F%2==0){return{classes:"odd_row"}}else{return{classes:"even_row"}}}});getLoginData(C,B,1,50)}function bindEvent(){window.operationEvents={"click .operationName":function(A,D,C,B){openDetailVisit(C.customerID,C.operationVisit)}};window.businessEvents={"click .businessName":function(A,D,C,B){openDetailVisit(C.customerID,C.businessVisit)}};window.detailVisitEvents={"click .edit":function(A,D,C,B){$("#createVisitLabel").text("修改回访信息");$("#updateVisit").show();$("#insertVisit").hide();openUpdateVisit(C)},"click .remove":function(A,D,C,B){delvisit(C)}};window.loginEvents={"click .edit":function(A,D,C,B){openCustomerVisit(C)}};window.viewCustomerInfo={"click .customerName":function(A,D,C,B){window.location.href="customerInfo.jsp?menuID=2&customerID="+C.customerID}};$("#searchCompany").off("keyup drop").on("keyup drop",function(A){if(A.keyCode=="13"){query()}});$('a[data-toggle="tab"]').on("shown.bs.tab",function(A){toggleTab(A)});$("#confirm").click(function(){query()});$("#btnMenu").click(function(A){queryByMenu(A)});$("#insertVisit").click(function(){insertVisit()});$("#updateVisit").click(function(){updateVisit()});$("#updateCustomerVisit").click(function(){updateCustomerVisit()})}function openDetailVisit(B,C){$("#visitData").bootstrapTable("destroy");var A=false;if($(window).width()<=768){A=true}$("#visitData").bootstrapTable({url:"getVisitList.do",cardView:A,undefinedText:"",cache:false,striped:true,pagination:true,search:true,showColumns:true,showToggle:true,showRefresh:true,queryParams:{"customerID":B,"personID":C},responseHandler:function(D){if($("#viewDetailVisit .fixed-table-toolbar").find("div").hasClass("columns pull-left")==false){$("#viewDetailVisit .fixed-table-toolbar").append('<div class="columns pull-left"><button id="createVisit" class="btn btn-success" type="button"><i class="glyphicon glyphicon-plus"></i>创建</button></div>')}$("#createVisit").unbind("click");$("#createVisit").click(function(){$("#createVisitLabel").text("新建回访信息");$("#updateVisit").hide();$("#insertVisit").show();createVisit(B,C)});return D.content}});$("#viewDetailVisit").modal({backdrop:"static",keyboard:false})}function createVisit(A,B){$("#inputcustomerID").val(A);$("#inputpersonID").val(B);$("#inputVisitName").val("");$("#inputContactWay").val("");$("#visitDetail").val("");$("#createVisitModal").modal({backdrop:"static",keyboard:false});initSelectbox($("#visitWaySlect"),"10001004")}function openUpdateVisit(A){$("#createVisitModal").modal({backdrop:"static",keyboard:false});initSelectbox($("#visitWaySlect"),"10001004");$("#inputvisitID").val(A.visitID);$("#inputVisitName").val(A.visitName);$("#inputContactWay").val(A.contactWay);$("#visitWaySlect").val(A.visitWay);$("#visitDetail").val(A.visitDetail.replace(new RegExp("<br>","gm"),"\n"))}function insertVisit(){var A={"customerID":$("#inputcustomerID").val(),"personID":$("#inputpersonID").val(),"visitName":$("#inputVisitName").val(),"contactWay":$("#inputContactWay").val(),"visitWay":$("#visitWaySlect").val(),"visitWayName":$("#visitWaySlect").find("option:selected").text(),"visitDetail":$("#visitDetail").val().replace(new RegExp("\n","gm"),"<br>")};$.ajax({url:"insertVisit.do",data:{"visitData":JSON.stringify(A)},method:"post",async:true,success:function(B){if(B.statusCode==504){$.messager.popup("系统错误，错误代码504。")}else{if(B.statusCode==4){window.open("login.jsp")}else{$.messager.popup("添加成功");$("#createVisitModal").modal("hide");$("#visitData").bootstrapTable("refresh")}}}})}function updateVisit(){var A={"visitID":$("#inputvisitID").val(),"visitName":$("#inputVisitName").val(),"contactWay":$("#inputContactWay").val(),"visitWay":$("#visitWaySlect").val(),"visitWayName":$("#visitWaySlect").find("option:selected").text(),"visitDetail":$("#visitDetail").val().replace(new RegExp("\n","gm"),"<br>")};$.ajax({url:"updateVisit.do",data:{"visitData":JSON.stringify(A)},method:"post",async:true,success:function(B){if(B.statusCode==504){$.messager.popup("系统错误，错误代码504。")}else{if(B.statusCode==4){window.open("login.jsp")}else{$.messager.popup("修改成功");$("#createVisitModal").modal("hide");$("#visitData").bootstrapTable("refresh")}}}})}function openCustomerVisit(A){$.ajax({url:"getVisitSelect.do",method:"post",async:true,success:function(E){$("#inputcustomerID").val(A.customerID);var D=E.content.operations;var C=E.content.customerStatus;var B=setOption(D,1);$("#operationVisitSlect").html(B.join(""));B=setOption(C,1);$("#customerStatusSlect").html(B.join(""));$("#operationVisitSlect").val(A.operationVisit);$("#customerStatusSlect").val(A.customerStatus);$("#customerVisitModal").modal({backdrop:"static",keyboard:false})}})}function updateCustomerVisit(){var A={"customerStatus":$("#customerStatusSlect").val(),"customerStatusName":$("#customerStatusSlect").find("option:selected").text(),"operationVisit":$("#operationVisitSlect").val(),"operationVisitName":$("#operationVisitSlect").find("option:selected").text(),"customerID":$("#inputcustomerID").val()};$.ajax({url:"saveCustomerVisit.do",data:{"customer":JSON.stringify(A)},method:"post",async:true,success:function(C){if(C.statusCode==504){$.messager.popup("系统错误，错误代码504。")}else{if(C.statusCode==4){window.open("login.jsp")}else{$.messager.popup("修改成功");$("#customerVisitModal").modal("hide");for(var H=0;H<$("#productTab > li").length;H++){if($($("#productTab > li")[H]).hasClass("active")){var I=$($("#productTab > li")[H]).text();if(I=="未登录公司"){var E=$("#notloginCustomer").bootstrapTable("getOptions");var D=E.pageNumber;var F=E.pageSize;var B=E.sortName;var G=E.sortOrder;getLoginData($("#notloginCustomer"),"getNotLoginList.do",D,F,B,G)}else{if(I=="登陆公司"){var E=$("#loginCustomer").bootstrapTable("getOptions");var D=E.pageNumber;var F=E.pageSize;var B=E.sortName;var G=E.sortOrder;getLoginData($("#loginCustomer"),"getLoginList.do",D,F,B,G)}}}}}}}})}function toggleTab(C){var D=$(C.target).text();if($(C.target)[0].title){D=$(C.target)[0].title}var A=$($(C.target)[0].hash).find("div").attr("id");var G=$("#dropdownBtn").text().replace(/(^\s*)|(\s*$)/g,"");var F="";for(var B=0;B<$("#productTab").find("li").length;B++){if($($("#productTab > li")[B]).hasClass("active")){F=$($("#productTab > li")[B]).text()}}if(D=="登陆次数"){$("#dropdownBtn").show();initCountTable($("#loginCount"),"logincount.do",0)}else{if(D=="菜单点击"){$("#dropdownBtn").show();initCountTable($("#menuClick"),"getPageClick.do",1)}else{if(D=="登陆公司"){$($(C.target)[0].hash+" a:first").tab("show");$("#dropdownBtn").hide();lineCharts("getLoginCpEveryDay.do","loginCPEveryDay")}else{if(D=="未登录公司"){$("#dropdownBtn").hide();initLoginTable($("#notloginCustomer"),"getNotLoginList.do")}else{if(D=="平台注册"){$($(C.target)[0].hash+" a:first").tab("show");$("#dropdownBtn").hide();showCharts("getPlatformRegAccount.do","platformRegpies")}else{if(D=="饼图"){$("#dropdownBtn").hide();showCharts("getPlatformRegAccount.do","platformRegpies")}else{if(D=="曲线图"){if(A=="platformRegline"){$("#dropdownBtn").hide();lineCharts("getChartRegDatas.do",A,G);lineCharts("getChartRegUpload.do","regUploadline")}else{$("#dropdownBtn").hide();lineCharts("getLoginCpEveryDay.do",A)}}else{if(D=="表格"){$("#dropdownBtn").hide();var E=$($(C.target)[0].hash).find("table");if(E.attr("id")=="platformRegTable"){showTable(E,"getChartRegTabDatas.do")}else{initLoginTable($("#loginCustomer"),"getLoginList.do")}}else{if(D=="平台问题"){$("#dropdownBtn").hide();showCharts("getPlatformAccount.do","platformProblemAmount")}else{if(D=="平台CP"){$("#dropdownBtn").hide();showCharts("getProblemCPAccount.do","platformCPAmount")}else{if(D=="新增CP"){$("#dropdownBtn").hide();showTable($("#addCPTable"),"getNewCPDatas.do")}else{if(D=="回传统计"){$("#dropdownBtn").hide();showCharts("getPlatformUploadAccount.do","uploadTimepies")}}}}}}}}}}}}}function query(){var D=$("#dropdownBtn").text().replace(/(^\s*)|(\s*$)/g,"");for(var A=0;A<$("#productTab > li").length;A++){if($($("#productTab > li")[A]).hasClass("active")){var C=$($("#productTab > li")[A]).text();if(C=="登陆次数"){initCountTable($("#loginCount"),"logincount.do",0)}else{if(C=="菜单点击"){initCountTable($("#menuClick"),"getPageClick.do",1)}else{if(C=="登陆公司"){lineCharts("getLoginCpEveryDay.do","loginCPEveryDay")}else{if(C=="未登录公司"){initLoginTable($("#notloginCustomer"),"getNotLoginList.do")}else{if(C=="平台注册"){var B="";for(var E=0;E<$("#regUpload").find("li").length;E++){if($($("#regUpload").find("li")[E]).hasClass("active")==true){B=$($("#regUpload").find("li")[E]).find("a")[0].title}}if(B=="曲线图"){lineCharts("getChartRegDatas.do","platformRegline");lineCharts("getChartRegUpload.do","regUploadline")}else{if(B=="饼图"){showCharts("getPlatformRegAccount.do","platformRegpies")}else{showTable($("#platformRegTable"),"getChartRegTabDatas.do")}}}else{if(C=="平台CP"){showCharts("getProblemCPAccount.do","platformCPAmount")}else{if(C=="新增CP"){showTable($("#addCPTable"),"getNewCPDatas.do")}else{if(C=="回传统计"){showCharts("getPlatformUploadAccount.do","uploadTimepies")}}}}}}}}}}}function queryByMenu(A){var B=$(A.target).text();$("#dropdownBtn").text(B).append('<span class="caret">');query()}function delvisit(A){$.messager.confirm("","确定删除该条回访信息？",function(){$.ajax({url:"delVisit.do",data:{"visitID":A.visitID},method:"post",async:true,success:function(B){if(B.statusCode==504){$.messager.popup("系统错误，错误代码504。")}else{if(B.statusCode==4){window.open("login.jsp")}else{$.messager.popup("删除成功");$("#visitData").bootstrapTable("refresh")}}}})})};