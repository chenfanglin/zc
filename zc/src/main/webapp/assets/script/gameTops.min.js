$(document).ready(function(){initPages();bindEvent()});function initPages(){initDateSelect();initfilter();var B=$(window).height()-120;var A=false;if($(window).width()<=768){A=true}$("#gameTops").bootstrapTable({cardView:A,undefinedText:"",cache:false,height:B,striped:true,pagination:true,pageSize:50,pageList:[10,25,50,100,200],sidePagination:"server",onPageChange:function(D,C){var E=$("#gameTops").bootstrapTable("getOptions");var F=E.sortName;var G=E.sortOrder;getData(D,C,F,G)},onSort:function(E,F){var D=$("#gameTops").bootstrapTable("getOptions");var G=D.pageNumber;var C=D.pageSize;getData(G,C,E,F)},rowStyle:function(C,D){if(D%2==0){return{classes:"odd_row"}}else{return{classes:"even_row"}}}});getData(1,50)}function getData(C,A,B,D){var E=buildCondition(C,A,B,D);$("#gameTops").bootstrapTable("showLoading");$.ajax({url:"getAllGameDatas.do",data:{"queryParam":JSON.stringify(E)},method:"post",async:true,success:function(G){if(G.statusCode==504){$.messager.popup("系统错误，错误代码504。")}else{var F={total:G.content.totalRecord,rows:G.content.gameData};$("#gameTops").bootstrapTable("hideLoading");$("#gameTops").bootstrapTable("load",F);addActiveClass()}}})}function initfilter(){$.ajax({url:"getGameSelect.do",method:"post",async:true,success:function(G){var B=G.content.platformType;var E=G.content.network;var D=G.content.platformMobile;var F=G.content.parentTags;var A=G.content.childTags;var C=setOption(B);$("#productPlatformSelect").html(C.join(""));C=setOption(E);$("#networkSelect").html(C.join(""));C=setOption(D);$("#platformMobileSelect").html(C.join(""));initCondition(F,A)}})}function initCondition(C,A){var B=[];$.each(C,function(D,E){B.push('<div class="form-group form-group-sm"><div class="select select-list"><label class="col-sm-1 control-label">'+E.text+'</label><div class="col-sm-11"><dl id="select'+E.value+'" class="conditiondl">');$.each(A,function(F,G){if(F==0){B.push('<dd class="select-all selected"><a href="javascript:void(0)">全部</a></dd>')}else{if(G.parentTag==E.value){B.push('<dd><a href="#'+G.tagID+'">'+G.tagName+"</a></dd>")}}});B.push("</dl></div></div></div>")});$("#conditiondiv").html(B.join(""));addConditionEvent(C)}function addConditionEvent(A){$.each(A,function(B,C){$("#select"+C.value+" dd").click(function(){$(this).addClass("selected").siblings().removeClass("selected");if($(this).hasClass("select-all")){$("#select"+B+"").remove()}else{var D=$(this).clone();if($("#select"+B+"").length>0){$("#select"+B+" a").html($(this).text())}else{$(".select-result dl").append(D.attr("id","select"+B+""));$("#select"+B+"").click(function(){$(this).remove();$("#select"+C.value+" .select-all").addClass("selected").siblings().removeClass("selected");if($(".select-result dd").length>1){$(".select-no").hide()}else{$(".select-no").show()}})}}if($(".select-result dd").length>1){$(".select-no").hide()}else{$(".select-no").show()}})})}function bindEvent(){window.gameEvents={"click .edit":function(A,D,C,B){openEditGame(C)}};window.themeEvents={"click .edit":function(A,D,C,B){openThemes(C)}};window.tagEvents={"click .edit":function(A,D,C,B){openTags(C)}};window.viewCustomerInfo={"click .customerName":function(A,D,C,B){window.location.href="customerInfo.jsp?menuID=2&customerID="+C.customerID}};$("#updateGameInfo").click(function(){updateGameInfo()});$("#saveThemeData").click(function(){saveThemeData()});$("#saveTagData").click(function(){saveTagData()});$("#serachGames").off("keyup drop").on("keyup drop",function(A){if(A.keyCode=="13"){keySearch()}});$("#confirm").click(function(A){query();cancel()});$("#exportExcel").click(function(){exportExcel()})}function keySearch(){var A=$("#gameTops").bootstrapTable("getOptions");var B=A.sortName;var C=A.sortOrder;getData(1,50,B,C)}function openEditGame(A){$("#inputappID").val(A.appID);$("#inputGameName").val(A.gameName);$("#inputOtherName").val(A.otherName);$("#gameTopsModal").modal({backdrop:"static",keyboard:false});$.ajax({url:"getGameInfoSelect.do",method:"post",async:true,success:function(G){var D=G.content.network;var E=G.content.gameTypes;var C=G.content.gameRank;var F=G.content.gameStatus;var B=setOption(D,1);$("#networkFilter").html(B.join(""));B=setOption(E,1);$("#gameTypeSelect").html(B.join(""));B=setOption(C,1);$("#gameRankSelect").html(B.join(""));B=setOption(F,1);$("#gameStatusSelect").html(B.join(""));$("#networkFilter").val(A.network);$("#gameTypeSelect").val(A.gameType);$("#gameRankSelect").val(A.gameRank);$("#gameStatusSelect").val(A.gameStatus)}})}function updateGameInfo(){var A={"gameName":$("#inputOtherName").val(),"appID":$("#inputappID").val(),"gameType":$("#gameTypeSelect").val(),"network":$("#networkFilter").val(),"networkName":$("#networkFilter").find("option:selected").text(),"gameRank":$("#gameRankSelect").val(),"gameRankName":$("#gameRankSelect").find("option:selected").text(),"gameStatus":$("#gameStatusSelect").val(),"gameStatusName":$("#gameStatusSelect").find("option:selected").text()};$.ajax({url:"saveGameInfo.do",method:"post",data:{"gameData":JSON.stringify(A)},async:true,success:function(B){if(B.statusCode==4){window.open("login.jsp")}else{$.messager.popup("保存成功");$("#gameTopsModal").modal("hide");refreshTable($("#gameTops"))}}})}function openThemes(A){$("#saveTagData").hide();$("#saveThemeData").show();$("#inputgameTheme").val(A.gameTheme);$("#inputappID").val(A.appID);$("#commonModal").modal({backdrop:"static",keyboard:false});$("#commonLabel").text("游戏题材");$.ajax({url:"getAllGameThemes.do",method:"post",async:true,success:function(E){var D=E.content.oneTheme;var C=E.content.twoTheme;var B=E.content.threeTheme;initGameThemes(D,C,B,A)}})}function initGameThemes(D,E,B,A){var C=[];$.each(D,function(F,G){C.push('<div class="form-group form-group-sm">');var H=0;$.each(E,function(I,J){if(J.parentID==G.enumID){if(H==0){C.push('<div class="select select-list"><label class="col-sm-1 control-label">'+G.themeName+'<input type="hidden" value="'+G.enumID+'"></label>')}else{C.push('<div class="select select-list"><label class="col-sm-1 control-label"><input type="hidden" value="'+G.enumID+'"></label>')}if(J.themeName=="三国"||J.themeName=="武侠"){C.push('<div class="col-sm-11"><dl id="theme'+G.enumID+'" class="conditiontheme"><dd id="two'+J.themeID+'"><a href="#'+J.themeID+'">'+J.themeName+'</a><input type="hidden" value="'+J.themeID+'"></dd></dl></div></div>')}else{C.push('<label class="col-sm-1 control-label">'+J.themeName+"</label>");C.push('<div class="col-sm-10"><dl id="theme'+J.themeID+'" class="conditiontheme"><input type="hidden" value="'+J.themeID+'">');$.each(B,function(L,K){if(K.parentID==J.themeID){C.push('<dd id="themes'+K.themeID+'"><a href="#'+K.themeID+'">'+K.themeName+'</a><input type="hidden" value="'+K.themeID+'"></dd>')}});C.push("</dl></div></div>")}H++}});C.push("</div>")});$("#commonCondition").html(C.join(""));addThemeEvent(D,E);addThemeSelect(A)}function addThemeEvent(A,B){$.each(A,function(C,D){$("#theme"+D.enumID+" dd").click(function(){$(".select-list dd").removeClass("selected");$(this).addClass("selected")});$.each(B,function(E,F){if(F.parentID==D.enumID){$("#theme"+F.themeID+" dd").click(function(){$("#commonCondition .select-list dd").removeClass("selected");$(this).addClass("selected")})}})})}function addThemeSelect(A){if(A.gameTheme){var B=A.gameTheme.split(",");if(B.length==3){$("#themes"+B[2]+"").addClass("selected")}else{$("#two"+B[1]+"").addClass("selected")}}}function saveThemeData(){var B=$("#inputappID").val();var A=$("#commonCondition .select-list dd");$.each(A,function(G,D){if($(D).hasClass("selected")==true){var F=$(D).find("a").text();var C=$(D).find("input").val();var J=$(D).siblings("input").val();var I=$(D).parent().parent().siblings().find("input").val();if(C&&I){var E;if(J){E=I+","+J+","+C}else{E=I+","+C}var H={"appID":B,"gameTheme":E};saveGameData("saveGameTheme.do",H)}else{$.messager.popup("请选择游戏题材。")}}})}function saveGameData(A,B){$.ajax({url:A,method:"post",data:{"gameData":JSON.stringify(B)},async:true,success:function(C){if(C.statusCode==4){window.open("login.jsp")}else{$.messager.popup("保存成功");$("#commonModal").modal("hide");refreshTable($("#gameTops"))}}})}function openTags(A){$("#saveTagData").show();$("#saveThemeData").hide();$("#inputgameTags").val(A.gameTags);$("#inputappID").val(A.appID);$("#commonModal").modal({backdrop:"static",keyboard:false});$("#commonLabel").text("游戏标签");$.ajax({url:"getGameSelect.do",method:"post",async:true,success:function(D){var C=D.content.parentTags;var B=D.content.childTags;initGameTags(C,B,A)}})}function initGameTags(D,A,B){var C=[];$.each(D,function(E,F){C.push('<div class="form-group form-group-sm"><div class="select select-list"><label class="col-sm-1 control-label">'+F.text+'</label><div class="col-sm-11"><dl id="tag'+F.value+'" class="conditiondl">');$.each(A,function(G,H){if(H.parentTag==F.value){C.push('<dd id="tags'+H.tagID+'"><a href="#'+H.tagID+'">'+H.tagName+'<input type="hidden" value="'+H.tagID+'"></a></dd>')}});C.push("</dl></div></div></div>")});$("#commonCondition").html(C.join(""));addTagEvent(D);addSelectClass(B)}function addTagEvent(A){$.each(A,function(B,C){$("#tag"+C.value+" dd").click(function(){if($(this).hasClass("selected")==true){$(this).removeClass("selected")}else{$(this).addClass("selected")}})})}function addSelectClass(A){if(A.gameTags){var B=A.gameTags.split(",");for(var C=0;C<B.length;C++){$("#tags"+B[C]+"").addClass("selected")}}}function saveTagData(){var E=$("#inputappID").val();var C=$("#commonCondition .select-list dd");var A=[];$.each(C,function(F,G){if($(G).hasClass("selected")==true){A.push($(G).find("input").val())}});if(A.length==0){$.messager.popup("请选择游戏标签。")}else{var D=A.join(",");var B={"appID":E,"gameTags":D};saveGameData("saveGameTags.do",B)}}function query(){getData(1,50)}function exportExcel(){var B=$("#gameTops").bootstrapTable("getOptions");var C=B.sortName;var D=B.sortOrder;var A=buildCondition(1,50,C,D);window.location="exportGame.do?queryParam="+JSON.stringify(A)}function buildCondition(K,H,B,I){var F=dateRange.getCurrentDate().startDate;var D=dateRange.getCurrentDate().endDate;var C=$("#productPlatformSelect").val();var M=$("#productPlatformSelect").find("option:selected").text();if(C==-1){M=""}var J=$("#platformMobileSelect").val();var G=$("#platformMobileSelect").find("option:selected").text();if(J==-1){G=""}var A=$("#networkSelect").val();if(A==-1){A=""}var L=$("#serachGames").val();var E={"startDate":F,"endDate":D,"platform":M,"platformType":G,"network":A,"pageNumber":K,"pageSize":H,"sortName":B,"order":I,"keyValue":L};return E};