$(function(){initPages();bindEvent()});function initPages(){initDateSelect();initSelectFilter();var B=$(window).height()-120;var A=false;if($(window).width()<=768){A=true}$("#newGameData").bootstrapTable({cardView:A,undefinedText:"",cache:false,height:B,striped:true,pagination:true,pageSize:100,pageList:[10,25,50,100,200],sidePagination:"server",onPageChange:function(D,C){var E=$("#newGameData").bootstrapTable("getOptions");var F=E.sortName;var G=E.sortOrder;getData(D,C,F,G)},onSort:function(E,F){var D=$("#newGameData").bootstrapTable("getOptions");var G=D.pageNumber;var C=D.pageSize;getData(G,C,E,F)},rowStyle:function(C,D){if(D%2==0){return{classes:"odd_row"}}else{return{classes:"even_row"}}}});$("#inputflag").val(0);getData(1,50)}function getData(C,A,B,D){var E=buildCondition(C,A,B,D);$("#newGameData").bootstrapTable("showLoading");$.ajax({url:"queryNewGames.do",data:{"queryParam":JSON.stringify(E)},method:"post",async:true,success:function(G){if(G.statusCode==504){$.messager.popup("系统错误，错误代码504。")}else{var F={total:G.content.totalRecord,rows:G.content.newGame};$("#newGameData").bootstrapTable("hideLoading");$("#newGameData").bootstrapTable("load",F);addActiveClass()}}})}function initSelectFilter(){$.ajax({url:"getNewGameSelect.do",method:"post",data:{"type":0,"parentID":0,},async:false,success:function(D){var C=D.content.gameType;var A=D.content.gameSource;var B=setOption(A);$("#gameSourceSelect").html(B.join(""));B=setOption(C);$("#gameTypeSelect").html(B.join(""));B=setOption(C,1);B.splice(1,1);$("#inputGameTypeSelect").html(B.join(""))}})}function bindEvent(){window.artEvents={"click .edit":function(A,D,C,B){openArt(C)}};window.playEvents={"click .edit":function(A,D,C,B){openPlay(C)}};window.themeEvents={"click .edit":function(A,D,C,B){openTheme(C)}};window.gameEvents={"click .gameName":function(A,D,C,B){$("#editGameInfo").modal({backdrop:"static",keyboard:false});viewGameInfo(C)}};$("#confirm").click(function(A){query();cancel()});$("#serachGames").off("keyup drop").on("keyup drop",function(A){if(A.keyCode=="13"){query()}});$("#playerRank").click(function(){$("#downloadNum").removeClass("btn-success").addClass("btn-default");$("#playerRank").removeClass("btn-default").addClass("btn-success");var B=dateRange.getCurrentDate().startDate;var A=dateRange.getCurrentDate().endDate;var C=$("#inputGameID").val();lineMonitorCharts("getPlayerRates.do","evaluation",B,A,C)});$("#downloadNum").click(function(){$("#playerRank").removeClass("btn-success").addClass("btn-default");$("#downloadNum").removeClass("btn-default").addClass("btn-success");var B=dateRange.getCurrentDate().startDate;var A=dateRange.getCurrentDate().endDate;var C=$("#inputGameID").val();lineDownloadCharts("getDownloadNums.do","evaluation",B,A,C)});$("#inputGameTypeSelect").change(function(){var A=$(this).children("option:selected").val();getDetailType(A)});$("#gameSourceFilter").change(function(){var A=$(this).children("option:selected").val();getGameTops(A)});$('a[data-toggle="tab"]').on("shown.bs.tab",function(A){toggleTab(A)});$("#saveArt").click(function(){saveMonitorTags(0)});$("#savePlay").click(function(){saveMonitorTags(1)});$("#saveTheme").click(function(){saveMonitorTags(2)});$("#saveGameInfo").click(function(){saveGameInfo()});$("#saveGameSort").click(function(){saveGameSort()});$("#exportExcel").click(function(){exportExcel()});$("#deleteGame").click(function(){deleteGame()});$("#addNewGame").click(function(){addNewGame()});$("#createGame").click(function(){openCreateGame()});$("#btnMenu").click(function(A){queryByMenu(A)})}function saveGameInfo(){var A={"id":$("#inputGameID").val(),"gameName":$("#inputGameName").val(),"companyName":$("#inputCompany").val(),"version":$("#inputVersion").val(),"device":$("#inputDevice").find("option:selected").text(),"network":$("#inputNetwork").val(),"clientSize":$("#inputClientSize").val(),"gameSource":$("#inputGameSource").val()};saveGameData("saveNewGameInfo.do",A)}function saveGameSort(){var A={"id":$("#inputGameID").val(),"gameRank":$("#inputGameRank").val(),"screenType":$("#inputScreenType").val(),"screenDirection":$("#inputScreenDirection").val(),"perspective":$("#inputPerspective").val(),"styleArea":$("#inputStyleArea").val(),"gameType":$("#inputGameTypeSelect").val(),"detailType":$("#inputDetailTypeSelect").val(),"homogenization":$("#inputTzhSelect").val(),"gameTheme":$("#inputGameTheme").val(),"ipinfo":$("#inputIP").val(),"authorize":$("#inputAuthorize").val(),"remark":$("#remarkInfo").val().replace(new RegExp("\n","gm"),"<br>")};saveGameData("saveGameSort.do",A)}function saveGameData(A,B){$.ajax({url:A,data:{"flag":Number.parseInt($("#inputflag").val()),"newGame":JSON.stringify(B)},method:"post",async:true,success:function(C){if(C.statusCode==504){$.messager.popup("系统错误，错误代码504。")}else{if(C.statusCode==4){window.open("login.jsp")}else{$.messager.popup("保存成功");refreshTable($("#newGameData"))}}}})}function getDetailType(A){$.ajax({url:"getNewGameTypes.do",method:"post",data:{"type":1,"parentID":A,},async:false,success:function(C){var B=C.content;option=setOption(B,1);$("#inputDetailTypeSelect").html(option.join(""))}});$.ajax({url:"getNewGameTypes.do",method:"post",data:{"type":2,"parentID":A,},async:false,success:function(C){var B=C.content;option=setOption(B,1);$("#inputTzhSelect").html(option.join(""))}})}function toggleTab(A){var B=$(A.target).text();if($(A.target)[0].title){B=$(A.target)[0].title}if(B=="游戏概况"){initGameInfo()}else{if(B=="市场表现"){var C=$("#inputflag").val();if(C==0){$("#playerRank").show();$("#downloadNum").show();$("#condition").hide()}else{$("#playerRank").hide();$("#downloadNum").hide();$("#condition").show()}initMaketShow(C)}else{if(B=="基础信息"){$("#saveGameInfo").show();$("#saveGameSort").hide()}else{if(B=="游戏简介"){$("#saveGameInfo").hide();$("#saveGameSort").hide()}else{if(B=="游戏分类"){$("#saveGameInfo").hide();$("#saveGameSort").show()}}}}}}function initGameInfo(){$("#gameInfoTab a:first").tab("show");$("#saveGameInfo").show();$("#saveGameSort").hide();var A=$("#inputGameID").val();setGameInfo(A)}function initMaketShow(C){$("#saveGameInfo").hide();$("#saveGameSort").hide();var B=dateRange.getCurrentDate().startDate;var A=dateRange.getCurrentDate().endDate;if(C==0){var D=$("#inputGameID").val();$("#downloadNum").removeClass("btn-success").addClass("btn-default");$("#playerRank").removeClass("btn-default").addClass("btn-success");lineMonitorCharts("getPlayerRates.do","evaluation",B,A,D)}else{var D=$("#inputGameID").val();$.ajax({url:"getHotGameSource.do",method:"post",data:{"gameID":D},async:true,success:function(G){var E=G.content.gameSource;var F=setOption(E);if(F.length>0){F.shift();$("#gameSourceFilter").html(F.join(""));getGameTops($("#gameSourceFilter").val())}}})}}function getGameTops(C){var D=$("#inputGameID").val();var B=dateRange.getCurrentDate().startDate;var A=dateRange.getCurrentDate().endDate;lineGameTopsCharts("getHotGameTops.do","evaluation",B,A,D,C)}function openArt(A){$("#inputGameID").val(A.id);$("#saveArt").show();$("#savePlay").hide();$("#saveTheme").hide();$("#monitorModal").modal({backdrop:"static",keyboard:false});$("#monitorLabel").text("美术及定位标签");$.ajax({url:"getNewGameTags.do",method:"post",data:{"type":0},async:true,success:function(D){var C=D.content.parentTag;var B=D.content.childTag;initGameTags(C,B,A.gameArt)}})}function openPlay(A){$("#inputGameID").val(A.id);$("#saveArt").hide();$("#savePlay").show();$("#saveTheme").hide();$("#monitorModal").modal({backdrop:"static",keyboard:false});$("#monitorLabel").text("玩法标签");$.ajax({url:"getNewGameTags.do",method:"post",data:{"type":1},async:true,success:function(D){var C=D.content.parentTag;var B=D.content.childTag;initGameTags(C,B,A.gamePlay)}})}function openTheme(A){$("#inputGameID").val(A.id);$("#saveArt").hide();$("#savePlay").hide();$("#saveTheme").show();$("#monitorModal").modal({backdrop:"static",keyboard:false});$("#monitorLabel").text("题材标签");$.ajax({url:"getNewGameTags.do",method:"post",data:{"type":2},async:true,success:function(D){var C=D.content.parentTag;var B=D.content.childTag;initGameTags(C,B,A.gameThemeTag)}})}function saveMonitorTags(E){var F=$("#inputGameID").val();var C=$("#monitortags .select-list dd");var A=[];$.each(C,function(G,H){if($(H).hasClass("selected")==true){A.push($(H).find("input").val())}});if(A.length==0){$.messager.popup("请选择标签。")}else{var D=A.join(",");var B={"gameID":F,"gameTags":D,"flag":E};saveGameTags("saveMonitorTags.do",B)}}function saveGameTags(A,B){$.ajax({url:A,method:"post",data:{"flag":Number.parseInt($("#inputflag").val()),"gameData":JSON.stringify(B)},async:true,success:function(C){if(C.statusCode==4){window.open("login.jsp")}else{$.messager.popup("保存成功");$("#monitorModal").modal("hide");refreshTable($("#newGameData"))}}})}function query(){var C=$("#newGameData").bootstrapTable("getOptions");var D=C.sortName;var E=C.sortOrder;var B=C.pageNumber;var A=C.pageSize;getData(B,A,D,E)}function viewGameInfo(A){$("#inputGameID").val(A.id);$("#monitorTab a:first").tab("show");initGameInfo(A)}function setGameInfo(A){$.ajax({url:"getNewGameInfo.do",data:{"flag":Number.parseInt($("#inputflag").val()),"gameID":A},method:"post",async:true,success:function(D){if(D.statusCode==504){$.messager.popup("系统错误，错误代码504。")}else{var G=D.content[0];$("#inputGameName").val(G.gameName);$("#inputCompany").val(G.companyName);$("#inputGameSource").val(G.gameSource);$("#inputPublishDate").val(G.publishDate);$("#inputVersion").val(G.version);for(var F=0;F<$("#inputDevice option").length;F++){if($("#inputDevice option")[F].text==G.device){var H=$("#inputDevice option")[F].value;$("#inputDevice").val(H)}}$("#inputNetwork").val(G.network);$("#inputClientSize").val(G.clientSize);var I=Number.parseInt($("#inputflag").val());if(I==0){$("#inputGameSource").removeAttr("readonly")}else{$("#inputGameSource").attr("readonly","readonly")}$("#gameLogo").fileinput({enctype:"multipart/form-data",showUpload:true,showCaption:false,uploadUrl:"uploadLogo.do",uploadAsync:true,maxFileCount:1,maxFileSize:500,allowedFileExtensions:["jpg","png","gif"],});$("#gameLogo").fileinput("refresh",{uploadExtraData:{"gameID":A,"flag":I},initialPreview:["<img src='"+G.gameLogo+"' class='file-preview-image' alt='logo' title='logo'>",]});$("#summary").text(G.summary);var C=G.gameScreen;if(C.length>0){var E=C.split(",");var J=[];var B=[];for(var F=0;F<E.length;F++){if(F==0){J.push('<div class="item active"><img src="'+E[F]+'" style="max-width:500px;max-height:360px;dispaly:block; margin:0 auto"></div>');B.push('<li data-target="#gameimages" data-slide-to="'+F+'" class="active"></li>')}else{J.push('<div class="item"><img src="'+E[F]+'" style="max-width:500px;max-height:360px;dispaly:block; margin:0 auto"></div>');B.push('<li data-target="#gameimages" data-slide-to="'+F+'"></li>')}}$("#summaryImg").html(J.join(""));$("#summaryZB").html(B.join(""))}$("#inputGameRank").val(G.gameRank);$("#inputScreenType").val(G.screenType);$("#inputScreenDirection").val(G.screenDirection);$("#inputPerspective").val(G.perspective);$("#inputStyleArea").val(G.styleArea);$("#inputGameTypeSelect").val(G.gameType);getDetailType(G.gameType);$("#inputDetailTypeSelect").val(G.detailType);$("#inputTzhSelect").val(G.homogenization);$("#inputGameTheme").val(G.gameTheme);$("#inputIP").val(G.ipinfo);$("#inputAuthorize").val(G.authorize);$("#remarkInfo").val(G.remark)}}})}function initGameTags(C,A,D){var B=[];$.each(C,function(E,F){B.push('<div class="form-group form-group-sm"><div class="select select-list"><label class="col-sm-1 control-label">'+F.tagName+'</label><div class="col-sm-11"><dl id="tag'+F.tagID+'" class="conditiondl">');$.each(A,function(G,H){if(H.parentTag==F.tagID){B.push('<dd id="tags'+H.tagID+'"><a href="#'+H.tagID+'">'+H.tagName+'<input type="hidden" value="'+H.tagID+'"></a></dd>')}});B.push("</dl></div></div></div>")});$("#monitortags").html(B.join(""));addTagEvent(C);addSelectClass(D)}function addTagEvent(A){$.each(A,function(B,C){$("#tag"+C.tagID+" dd").click(function(){if($(this).hasClass("selected")==true){$(this).removeClass("selected")}else{$(this).addClass("selected")}})})}function addSelectClass(C){if(C){var A=C.split(",");for(var B=0;B<A.length;B++){$("#tags"+A[B]+"").addClass("selected")}}}function queryChartData(B,A){var C=$("#inputGameID").val();lineMonitorCharts("getPlayerRates.do","evaluation",B,A,C)}function exportExcel(){var D=$("#newGameData").bootstrapTable("getOptions");var E=D.sortName;var F=D.sortOrder;var C=D.pageNumber;var B=D.pageSize;var A=buildCondition(C,B,E,F);window.location="exportNewGame.do?queryParam="+JSON.stringify(A)}function buildCondition(F,C,L,J){var Q=dateRange.getCurrentDate().startDate;var N=dateRange.getCurrentDate().endDate;var A=$("#inputflag").val();var H=$("#deviceFilter").find("option:selected").text();if(H=="全部"){H=""}var G=$("#networkFilter").val();if(G==-1){G=""}if(A==0){var M=$("#gameSourceSelect").find("option:selected").text();if(M=="全部"){M=""}}else{var M=$("#gameSourceSelect").val();if(M=="-1"){M=""}}var K=$("#gameRankFilter").val();if(K==-1){K=""}var B=$("#gameTypeSelect").val();if(B==-1){B=""}var P=$("#screenTypeFilter").val();if(P==-1){P=""}var E=$("#gameThemeFilter").val();if(E==-1){E=""}var D=$("#styleAreaFilter").val();if(D==-1){D=""}var O=$("#serachGames").val();var I={"startDate":Q,"endDate":N,"device":H,"network":G,"gameSource":M,"gameRank":K,"gameType":B,"screenType":P,"gameTheme":E,"styleArea":D,"pageNumber":F,"pageSize":C,"sortName":L,"order":J,"flag":Number.parseInt(A),"keyValue":O};return I}function openCreateGame(){$("#addGameModal").modal({backdrop:"static",keyboard:false});$("#publishTime").datetimepicker({format:"yyyy-mm-dd",todayBtn:true,autoclose:true,todayHighlight:1,startView:2,minView:2});$("#publishTime").val("");$("#inputNewGameName").val("");$("#inputCompanyName").val("");$("#inputDeviceType").val("");$("#inputGameSummary").val("")}function addNewGame(){var A={"gameName":$("#inputNewGameName").val(),"publishDate":$("#publishTime").val(),"companyName":$("#inputCompanyName").val(),"device":$("#inputDeviceType").find("option:selected").text(),"summary":$("#inputGameSummary").val()};$.ajax({url:"addNewGame.do",data:{"flag":Number.parseInt($("#inputflag").val()),"newGame":JSON.stringify(A)},method:"post",async:true,success:function(B){if(B.statusCode==504){$.messager.popup("系统错误，错误代码504。")}else{if(B.statusCode==4){window.open("login.jsp")}else{$.messager.popup("添加成功");$("#addGameModal").modal("hide");refreshTable($("#newGameData"))}}}})}function deleteGame(){var A=$("#newGameData").bootstrapTable("getSelections");if(A.length>0){$.messager.confirm("","确定删除所选游戏信息？",function(){$.ajax({url:"deleteNewGame.do",data:{"flag":Number.parseInt($("#inputflag").val()),"newGames":JSON.stringify(A)},method:"post",async:true,success:function(B){if(B.statusCode==504){$.messager.popup("系统错误，错误代码504。")}else{if(B.statusCode==4){window.open("login.jsp")}else{$.messager.popup("删除成功");refreshTable($("#newGameData"))}}}})})}else{$.messager.popup("请勾选需要删除的游戏信息。")}}function queryByMenu(A){var B=$(A.target).text();$("#dropdownBtn").text(B).append('<span class="caret">');if(B=="新品游戏"){$("#inputflag").val(0)}else{$("#inputflag").val(1)}query()}function lineMonitorCharts(H,G,D,I,E){var B=new Highcharts.Chart({chart:{renderTo:G,plotBackgroundColor:null,defaultSeriesType:"spline",plotBorderWidth:null,plotShadow:false,},title:{text:null,},credits:{enabled:false},yAxis:{title:{text:"分数"},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{crosshairs:true,shared:true,valueSuffix:"分"},plotOptions:{line:{dataLabels:{enabled:true},enableMouseTracking:true}}});var A=[];var C=[];var F={"startDate":D,"endDate":I,"id":E};B.showLoading();$.ajax({url:H,dataType:"json",data:{"queryParam":JSON.stringify(F)},type:"post",async:true,success:function(M){if(M.statusCode==200){B.hideLoading();A=M.content.dateLists;C=M.content.graphDataModel;var J=[];for(var K=0;K<C.length;K++){var L={name:C[K].name,data:C[K].dataRank};B.addSeries(L);J.push(L)}B.xAxis[0].setCategories(A)}}})}function lineDownloadCharts(H,G,D,I,E){var B=new Highcharts.Chart({chart:{renderTo:G,plotBackgroundColor:null,defaultSeriesType:"spline",plotBorderWidth:null,plotShadow:false,},title:{text:null,},credits:{enabled:false},yAxis:{title:{text:"次数"},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{crosshairs:true,shared:true,valueSuffix:"次"},plotOptions:{line:{dataLabels:{enabled:true},enableMouseTracking:true}}});var A=[];var C=[];var F={"startDate":D,"endDate":I,"id":E};B.showLoading();$.ajax({url:H,dataType:"json",data:{"queryParam":JSON.stringify(F)},type:"post",async:true,success:function(M){if(M.statusCode==200){B.hideLoading();A=M.content.dateLists;C=M.content.graphDataModel;var J=[];for(var K=0;K<C.length;K++){var L={name:C[K].name,data:C[K].dataRank};B.addSeries(L);J.push(L)}B.xAxis[0].setCategories(A)}}})}function lineGameTopsCharts(I,H,E,J,F,A){var C=new Highcharts.Chart({chart:{renderTo:H,plotBackgroundColor:null,defaultSeriesType:"spline",plotBorderWidth:null,plotShadow:false,},title:{text:null,},credits:{enabled:false},yAxis:{title:{text:"名次"},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{crosshairs:true,shared:true,valueSuffix:"名"},plotOptions:{line:{dataLabels:{enabled:true},enableMouseTracking:true}}});var B=[];var D=[];var G={"startDate":E,"endDate":J,"id":F,"channelID":A};C.showLoading();$.ajax({url:I,dataType:"json",data:{"queryParam":JSON.stringify(G)},type:"post",async:true,success:function(N){if(N.statusCode==200){C.hideLoading();B=N.content.dateLists;D=N.content.graphDataModel;var K=[];for(var L=0;L<D.length;L++){var M={name:D[L].name,data:D[L].dataRank};C.addSeries(M);K.push(M)}C.xAxis[0].setCategories(B)}}})};